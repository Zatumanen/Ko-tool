<!DOCTYPE html>

<html lang="ru">
<head>


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>KO II Audio Tool v1.41</title>
<style>
    body {
      background: #fff;
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .window {
      width: 100%;
      max-width: 420px;
      background: #c0c0c0;
      border: 2px solid #000;
      box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
      padding: 10px;
      box-sizing: border-box;
    }
    .title-bar {
      background: #000080;
      color: #fff;
      padding: 4px 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title-bar button {
      width: 18px;
      height: 18px;
      border: none;
      background: #c0c0c0;
      cursor: pointer;
    }
    .title-bar .minimize { background: #fff; }
    .title-bar .close { background: #ff0000; }

    .content {
      padding: 10px 0;
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .options label,
    .settings label {
      font-size: 16px;
    }

    .options input[type="radio"] {
      margin-right: 5px;
      transform: scale(1.3);
    }

    .settings {
      margin-top: 10px;
      padding: 5px;
      background: #2d7038;
    }

    .slider {
      width: 100%;
      height: 12px;
      background: #000;
      appearance: none;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      background: #ffd700;
      cursor: pointer;
    }

    .drop-zone {
      border: 2px dashed #000;
      padding: 14px;
      text-align: center;
      background: rgba(255, 255, 255, 0.3);
      margin-top: 12px;
      position: relative;
    }

    .drop-zone input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .drop-zone span {
      pointer-events: none;
      font-size: 16px;
    }

    #file-info {
      margin-top: 10px;
      font-size: 14px;
      text-align: left;
    }

    button#select-file-button {
      width: 100%;
      margin-top: 10px;
      background: #c0c0c0;
      border: 2px solid #000;
      color: #000;
      font-family: 'Courier New', monospace;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    audio#player {
      width: 100%;
      margin-top: 12px;
    }

    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
    }

    #win95-loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      padding: 12px;
      background: #c0c0c0;
      border: 2px solid #000;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #000;
      display: none;
      z-index: 1000;
    }

    .progress-bar-container {
      background: #fff;
      border: 2px inset #808080;
      height: 18px;
      margin-top: 8px;
      display: flex;
      padding: 2px;
      gap: 1px;
      justify-content: flex-start;
    }

    .progress-segment {
      width: 6px;
      height: 100%;
      background: #c0c0c0;
    }

    .progress-segment.active {
      background: #000080;
    }
  
    .slider-wrapper {
      display: flex;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }

    .slider-value {
      background: #fff;
      border: 2px inset #808080;
      padding: 2px 6px;
      font-size: 14px;
      min-width: 36px;
      text-align: center;
      font-family: 'Courier New', monospace;
      color: #000;
    }


.win95-inset {
  border: 2px inset #808080;
  background: #c0c0c0;
  padding: 6px;
  margin-bottom: 6px;
}


.win95-list {
  border: 2px inset #808080;
  background: #fff;
  padding: 4px;
  font-family: 'Courier New', monospace;
}

.list-item {
  padding: 2px 6px;
  cursor: pointer;
  user-select: none;
}

.list-item:hover {
  background: #c0c0c0;
}

.list-item.selected {
  background: #000080;
  color: white;
}
</style>
<script src="https://unpkg.com/wavesurfer.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script></head>
<body>
<div class="window">
<div class="title-bar">
<span>KO II Audio Tool — v1.56</span>
<div>
<button class="minimize">-</button>
<button class="close">X</button>
</div>
</div>
<div class="content">
<div style="display: flex; gap: 8px; margin-bottom: 10px;">
<div class="win95-inset" style="flex: 1;">
<label>FIDELITY</label><br/>
<div class="win95-list" data-group="fidelity">
<div class="list-item selected" data-value="cd">CD (16/46)</div>
<div class="list-item" data-value="sp8">SP-1200 8 Bit</div>
<div class="list-item" data-value="sp16">SP-1200 16 Bit</div>
<div class="list-item" data-value="sk">SK-1 (8/9)</div>
</div>
</div>
<div class="win95-inset" style="flex: 1;">
<label>CHANNELS</label><br/>
<div class="win95-list" data-group="channels">
<div class="list-item selected" data-value="stereo">Stereo</div>
<div class="list-item" data-value="mono">Mono</div>
</div>
</div>
</div>
</div>
<div class="settings win95-inset">
<label>EP-133 KO II SETTINGS</label>
<div class="slider-wrapper">
<label>Pitch</label>
<input class="slider" id="pitch-slider" max="127" min="0" oninput="updateSliderValue('pitch')" type="range" value="64"/>
<span class="slider-value" id="pitch-value">64</span>
</div>
<div class="slider-wrapper">
<label>Release</label>
<input class="slider" id="release-slider" max="255" min="0" oninput="updateSliderValue('release')" type="range" value="128"/>
<span class="slider-value" id="release-value">128</span>
</div>
</div>
<div class="drop-zone" id="drop-zone">
<input accept=".mp3,.wav,.ogg,audio/*" id="audio-upload" multiple="" type="file">
<span>DRAG AND DROP OR SELECT AUDIO FILES</span>
<div id="file-info"></div>
</input></div>
<div id="waveform-list" style="margin-top: 10px;"></div>
<button id="select-file-button">Select Audio Files</button>
</div>

<div id="overlay">
<div id="win95-loader">
<div>Copying...</div>
<div>From KO Tool to Player</div>
<div class="progress-bar-container" id="segment-container"></div>
</div>
</div>

<script>function renderWaveform(blob, filename) {
  console.log('Rendering file:', filename, 'Size:', blob?.size);
  if (!blob || blob.size === 0 || blob.size < 500) {
    console.warn('Waveform render skipped due to empty or too small blob:', filename);
    console.warn('Skipping empty or invalid blob:', filename);
    return;
  }

  const container = document.createElement('div');
  container.style.marginBottom = '20px';
  container.style.border = '2px inset #808080';
  container.style.padding = '10px';
  container.style.background = '#e0e0e0';
  container.style.overflowX = 'auto';

  const title = document.createElement('div');
  try {
    title.textContent = decodeURIComponent(filename);
  } catch {
    title.textContent = filename;
  }
  title.style.fontFamily = "'Courier New', monospace";
  title.style.fontSize = '14px';
  title.style.marginBottom = '6px';
  title.style.wordBreak = 'break-word';

  const wave = document.createElement('div');
  wave.style.width = '100%';
  wave.style.minHeight = '64px';
  wave.style.height = '64px';

  const button = document.createElement('button');
  button.textContent = '▶️ Play';
  button.style.marginTop = '6px';
  button.style.fontFamily = "'Courier New', monospace";

  const wavesurfer = WaveSurfer.create({
    container: wave,
    waveColor: '#000',
    progressColor: '#000080',
    height: 64,
    barWidth: 1.4,
    minPxPerSec: 100,
    responsive: true,
    cursorColor: '#ff0000',
    splitChannels: false
  });

  let didRender = false;
  const fallbackTimeout = setTimeout(() => {
    if (!didRender) {
      const failNote = document.createElement('div');
      failNote.textContent = '⚠️ Failed to render waveform';
      failNote.style.color = 'red';
      failNote.style.fontSize = '13px';
      container.appendChild(title);
      container.appendChild(failNote);
      document.getElementById('waveform-list').appendChild(container);
    }
  }, 4000);

  wavesurfer.on('ready', () => {
    clearTimeout(fallbackTimeout);
    didRender = true;
    container.appendChild(title);
    container.appendChild(wave);
    container.appendChild(button);
    document.getElementById('waveform-list').appendChild(container);
  });

  

wavesurfer.on('error', (e) => {
  console.warn('WaveSurfer error, recreating instance...');

  // Очистка старого экземпляра
  wavesurfer.destroy();
  wave.innerHTML = "";

  const newWavesurfer = WaveSurfer.create({
    container: wave,
    waveColor: '#000',
    progressColor: '#000080',
    height: 64,
    barWidth: 1.4,
    minPxPerSec: 100,
    responsive: true,
    cursorColor: '#ff0000',
    splitChannels: false
  });

  newWavesurfer.on('ready', () => {
    clearTimeout(fallbackTimeout);
    didRender = true;
    container.appendChild(title);
    container.appendChild(wave);
    container.appendChild(button);
    document.getElementById('waveform-list').appendChild(container);
  });

  
newWavesurfer.on('error', () => {
  console.warn('Second attempt failed to render:', filename);
  const failNote = document.createElement('div');
  failNote.textContent = '⚠️ Failed to render waveform (2nd attempt)';
  failNote.style.color = 'red';
  failNote.style.fontSize = '13px';
  container.innerHTML = '';
  container.appendChild(title);
  container.appendChild(failNote);
  document.getElementById('waveform-list').appendChild(container);
});


  try {
    newWavesurfer.loadBlob(blob);
  } catch (err2) {
    console.error('Retry loading failed:', err2);
  }
});



  try {
    wavesurfer.loadBlob(blob);
  } catch (err) {
    console.error('WaveSurfer loadBlob failed:', err);
  }

  button.onclick = () => {
    if (wavesurfer.isPlaying()) {
      wavesurfer.pause();
      button.textContent = '▶️ Play';
    } else {
      wavesurfer.play();
      button.textContent = '⏸ Pause';
    }
  };
}


const waveformQueue = [];
let waveformBusy = false;

function enqueueWaveformRender(blob, filename) {
  waveformQueue.push({ blob, filename });
  processNextWaveform();
}

function processNextWaveform() {
  if (waveformBusy || waveformQueue.length === 0) return;
  waveformBusy = true;

  const { blob, filename } = waveformQueue.shift();

  setTimeout(() => {
    try {
      renderWaveform(blob, filename);
    } catch (err) {
      console.error('Waveform render error:', err);
    } finally {
      waveformBusy = false;
      processNextWaveform();
    }
  }, 50); // слегка задержим для стабильности в Safari
}

</script>
</body>
</html></script></body>
</html>