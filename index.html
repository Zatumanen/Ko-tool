<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>SpeedUpperCut</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{
  --glow-color:#ff3333;
  --primary-blue:#000080;
  --win-gray:#c0c0c0;
  --win-light:#ffffff;
  --win-dark:#808080;
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  background:#008080 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4"><rect width="1" height="1" fill="%23808080"/></svg>');
  font-family:'Courier New',monospace;
  min-height:100vh;
  overflow-x:hidden;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}
.window{
  width:100%;
  max-width:480px;
  background:var(--win-gray);
  border:2px outset;
  position:relative;
  z-index:100;
}
.title-bar{
  background:var(--primary-blue);
  color:#fff;
  padding:4px 8px;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  user-select:none;
}
.title-bar button{
  width:20px;height:20px;
  border:1px outset;
  background:var(--win-gray);
  cursor:pointer;
}
.drop-zone{
  border:2px dashed #000;
  padding:20px;
  text-align:center;
  background:rgba(255,255,255,.3);
  position:relative;
  cursor:pointer;
}
.drop-zone input[type=file]{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  opacity:0;
  cursor:pointer;
}
.drop-zone.dragover{background:rgba(0,128,0,.3)}
.button-group{display:flex;gap:10px;margin-top:10px}
.button-group button{flex:1;min-height:44px}
.taskbar{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--win-gray);
  height:36px;
  border-top:2px outset;
  display:flex;
  align-items:center;
  padding:0 8px;
  z-index:90;
}
.start-button{
  padding:4px 8px;
  border:2px outset;
  cursor:pointer;
}
.status-bar{margin-left:auto}
.win95-list{height:100px;overflow-y:auto;border:2px inset #fff;background:#fff}
.list-item{padding:4px;cursor:pointer}
.list-item.selected{background:var(--primary-blue);color:#fff}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000}
#win95-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;padding:12px;background:var(--win-gray);border:2px outset}
.progress-bar-container{background:#fff;border:2px inset;height:24px;display:flex;gap:1px;padding:2px}
.progress-segment{background:var(--win-gray);width:8px}
.progress-segment.active{background:var(--primary-blue)}
.wave-window{position:absolute;width:500px;background:var(--win-gray);border:2px outset;z-index:101}
.wave-element-container{height:150px;background:#000;position:relative}
@media(max-width:768px){
  .window{width:95vw}
  .wave-window{width:90vw;left:5vw}
}
</style>
</head>
<body>
<div class="window" id="main-win">
  <div class="title-bar">
    <span>SpeedUpperCut</span>
    <div>
      <button onclick="mainWin.style.display='none'">×</button>
    </div>
  </div>
  <div class="content" style="padding:12px">
    <div>
      <label>FIDELITY</label>
      <div class="win95-list" id="fidelity">
        <div data-value="cd" class="list-item selected">CD (16-bit, 44.1kHz)</div>
        <div data-value="sk" class="list-item">SK-1 (8-bit, 9kHz)</div>
        <div data-value="sp8" class="list-item">SP-1200 (8-bit, 22kHz)</div>
        <div data-value="sp16" class="list-item">SP-1200 (16-bit, 22kHz)</div>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>CHANNELS</label>
      <div class="win95-list" id="channels">
        <div data-value="stereo" class="list-item selected">Stereo</div>
        <div data-value="mono" class="list-item">Mono</div>
      </div>
    </div>
    <div style="margin:8px 0">
      <label><input type="checkbox" id="auto-trim" checked> Auto-trim silence</label>
    </div>
    <div class="drop-zone" id="drop-zone">
      <i class="fas fa-cloud-upload-alt" style="font-size:36px"></i><br>
      <span>DRAG & DROP AUDIO FILES</span>
      <input type="file" multiple accept="audio/*" id="file-input">
    </div>
    <div class="button-group">
      <button onclick="fileInput.click()">Select Files</button>
      <button onclick="clearList()">Clear</button>
    </div>
    <div id="info" style="background:#fff;border:inset 1px;padding:6px;height:120px;overflow-y:auto;font-size:13px">
      Drop files to process
    </div>
  </div>
</div>

<div id="overlay">
  <div id="win95-loader">
    <div id="proc-title">Processing...</div>
    <div class="progress-bar-container" id="progress"></div>
    <button onclick="cancel=true">Cancel</button>
  </div>
</div>

<div class="taskbar">
  <div class="start-button"><i class="fas fa-bars"></i> Start</div>
  <div class="status-bar" id="status">Ready</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const MAX_PREVIEW = 5;
const MIN_DURATION = 0.5;
let cancel = false;
let waveWindows = [];
let audioCtx;

/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const info = $('#info');
const statusBar = $('#status');
const dropZone = $('#drop-zone');
const fileInput = $('#file-input');
const mainWin = $('#main-win');

function log(msg){
  info.insertAdjacentHTML('beforeend',`<div>${msg}</div>`);
  info.scrollTop = info.scrollHeight;
}
function setStatus(msg){statusBar.textContent=msg}
function showOverlay(b){$('#overlay').style.display=b?'block':'none'}

/* ---------- DRAG & DROP ---------- */
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{
  e.preventDefault();dropZone.classList.add('dragover')
}));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{
  e.preventDefault();dropZone.classList.remove('dragover');
  if(ev.type==='drop')handleFiles(e.dataTransfer.files)
}));
fileInput.addEventListener('change',e=>handleFiles(e.target.files));

/* ---------- AUDIO ---------- */
async function getCtx(){
  if(!audioCtx)audioCtx=new(window.AudioContext||webkitAudioContext)();
  if(audioCtx.state==='suspended')await audioCtx.resume();
  return audioCtx;
}

async function processBuffer(ab,fidelity,channels){
  const ctx = await getCtx();
  const buf = await ctx.decodeAudioData(ab.slice(0));
  const Offline = window.OfflineAudioContext||webkitOfflineAudioContext;
  const targetSR = fidelity==='sk'?9000:fidelity==='sp8'||fidelity==='sp16'?22050:44100;
  const targetCh = channels==='mono'?1:2;
  const dur = Math.max(buf.duration/2,MIN_DURATION);
  const off = new Offline(targetCh,dur*targetSR,targetSR);
  const src = off.createBufferSource();
  src.buffer = buf;
  src.playbackRate.value = 2;
  if(buf.numberOfChannels!==targetCh){
    const merger = off.createChannelMerger(targetCh);
    src.connect(merger);
    merger.connect(off.destination);
  }else{
    src.connect(off.destination);
  }
  src.start();
  return off.startRendering();
}

function audioBufferToWav(buf){
  const len=buf.length*buf.numberOfChannels*2;
  const arr=new ArrayBuffer(44+len);
  const v=new DataView(arr);
  const writeStr=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  writeStr(0,'RIFF');v.setUint32(4,36+len,true);
  writeStr(8,'WAVEfmt ');v.setUint32(16,16,true);
  v.setUint16(20,1,true);v.setUint16(22,buf.numberOfChannels,true);
  v.setUint32(24,buf.sampleRate,true);v.setUint32(28,buf.sampleRate*buf.numberOfChannels*2,true);
  v.setUint16(32,buf.numberOfChannels*2);v.setUint16(34,16,true);
  writeStr(36,'data');v.setUint32(40,len,true);
  let offset=44;
  for(let i=0;i<buf.length;i++){
    for(let c=0;c<buf.numberOfChannels;c++){
      const s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i]));
      v.setInt16(offset,s<0?s*0x8000:s*0x7FFF,true);
      offset+=2;
    }
  }
  return new Blob([arr],{type:'audio/wav'});
}

/* ---------- ZIP & UI ---------- */
async function handleFiles(files){
  if(!files.length)return;
  showOverlay(true);cancel=false;
  const zip=new JSZip();
  let done=0;
  const total=files.length;
  const progress=$('#progress');
  progress.innerHTML='';
  for(let i=0;i<50;i++){
    const s=document.createElement('div');s.className='progress-segment';
    progress.appendChild(s);
  }
  const segs=[...progress.children];
  for(const f of files){
    if(cancel)break;
    setStatus(`Processing ${f.name} (${done+1}/${total})`);
    const ab=await f.arrayBuffer();
    const buf=await processBuffer(ab,$('#fidelity .selected').dataset.value,$('#channels .selected').dataset.value);
    const wav=audioBufferToWav(buf);
    zip.file(f.name.replace(/\.[^/.]+$/,'_ko2.wav'),wav);
    done++;
    segs.forEach((s,i)=>s.classList.toggle('active',i<done/total*50));
  }
  if(!cancel){
    const blob=await zip.generateAsync({type:'blob'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);a.download='ko2_processed_audio.zip';a.click();
    setStatus(`Done: ${done} files`);
  }
  showOverlay(false);
}

function clearList(){info.innerHTML='Drop files to process'}

/* ---------- PREVIEW ---------- */
function addWave(title,url){
  if(waveWindows.length>=MAX_PREVIEW){
    const old=waveWindows.shift();
    old.win.remove();URL.revokeObjectURL(old.url);
  }
  const win=document.createElement('div');
  win.className='wave-window';
  win.style.top=60+waveWindows.length*25+'px';
  win.style.left=10+waveWindows.length*25+'px';
  win.innerHTML=`
    <div class="title-bar"><span>${title}</span><button onclick="this.closest('.wave-window').remove()">×</button></div>
    <div><div class="wave-element-container"><div class="wave-element"></div></div></div>
  `;
  document.body.appendChild(win);
  const ws=WaveSurfer.create({container:win.querySelector('.wave-element'),height:150,backend:'MediaElement'});
  ws.load(url);
  waveWindows.push({win,url});
}

/* ---------- INIT ---------- */
$('#fidelity').addEventListener('click',e=>{
  [...e.currentTarget.children].forEach(c=>c.classList.remove('selected'));
  e.target.classList.add('selected');
});
$('#channels').addEventListener('click',e=>{
  [...e.currentTarget.children].forEach(c=>c.classList.remove('selected'));
  e.target.classList.add('selected');
});
setStatus('Ready');
</script>
</body>
</html>
