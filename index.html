<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpeedUpperCut</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="24" y="40" width="16" height="16" fill="#e53935" stroke="black" stroke-width="2"/><rect x="26" y="44" width="12" height="4" fill="#b71c1c"/><polygon points="32,32 28,28 30,24 34,26 36,22 38,30" fill="orange" stroke="black" stroke-width="1"/></svg>'>
  <style>
    :root { 
      --glow-color: #ff3333; 
      --primary-blue: #000080;
      --win-gray: #c0c0c0;
      --win-light: #ffffff;
      --win-dark: #808080;
    }
    
    body {
      background: #008080;
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 1px 1px, var(--win-dark) 1px, transparent 0),
        radial-gradient(circle at 1px 1px, var(--win-dark) 1px, transparent 0);
      background-size: 4px 4px;
      background-position: 0 0, 2px 2px;
    }
    
    .desktop-icon {
      position: absolute;
      width: 80px;
      text-align: center;
      color: white;
      text-shadow: 1px 1px 1px black;
      cursor: pointer;
      padding: 4px;
      user-select: none;
      transition: transform 0.2s;
    }
    
    .desktop-icon:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
    }
    
    .window {
      width: 100%;
      max-width: 480px;
      background: var(--win-gray);
      border: 2px solid;
      border-top-color: var(--win-light);
      border-left-color: var(--win-light);
      border-right-color: var(--win-dark);
      border-bottom-color: var(--win-dark);
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      padding: 0;
      box-sizing: border-box;
      position: relative;
      z-index: 100;
    }
    
    .preview-window {
      display: none;
      width: 100%;
      max-width: 600px;
      background: var(--win-gray);
      border: 2px solid;
      border-top-color: var(--win-light);
      border-left-color: var(--win-light);
      border-right-color: var(--win-dark);
      border-bottom-color: var(--win-dark);
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      padding: 0;
      box-sizing: border-box;
      position: relative;
      z-index: 101;
      top: 20px;
      margin: 0 auto;
    }
    
    .title-bar {
      background: var(--primary-blue);
      color: #fff;
      padding: 4px 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--win-gray);
      cursor: move;
    }
    
    .title-bar button {
      width: 20px;
      height: 20px;
      border: none;
      background: var(--win-gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-family: Arial, sans-serif;
      margin-left: 4px;
      border: 1px solid;
      border-top-color: var(--win-light);
      border-left-color: var(--win-light);
      border-right-color: var(--win-dark);
      border-bottom-color: var(--win-dark);
    }
    
    .title-bar button.minimize { 
      font-size: 18px;
      line-height: 12px;
    }
    
    .title-bar button.close { 
      font-size: 14px;
    }
    
    .title-bar button:active {
      border-top-color: var(--win-dark);
      border-left-color: var(--win-dark);
      border-right-color: var(--win-light);
      border-bottom-color: var(--win-light);
    }
    
    .content {
      padding: 12px;
      font-size: 14px;
      color: #000;
    }
    
    .drop-zone {
      border: 2px dashed #000;
      padding: 20px;
      text-align: center;
      background: rgba(255, 255, 255, 0.3);
      margin-top: 12px;
      position: relative;
      cursor: pointer;
      border-style: dotted;
      border-color: var(--win-dark);
    }
    
    .drop-zone.dragover {
      background: rgba(0, 128, 0, 0.3);
    }
    
    .drop-zone input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .drop-zone span {
      pointer-events: none;
      font-size: 16px;
      display: block;
      margin-top: 10px;
    }
    
    #file-info {
      margin-top: 10px;
      font-size: 14px;
      text-align: left;
      background: #fff;
      border: 2px inset var(--win-dark);
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    button {
      min-height: 44px;
      padding: 10px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      border: 2px outset var(--win-gray);
      background: var(--win-gray);
      color: #000;
    }
    
    button:active {
      border-style: inset;
    }
    
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
    }
    
    #win95-loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      padding: 12px;
      background: var(--win-gray);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #000;
      z-index: 1001;
      border: 2px solid;
      border-top-color: var(--win-light);
      border-left-color: var(--win-light);
      border-right-color: var(--win-dark);
      border-bottom-color: var(--win-dark);
    }
    
    .progress-bar-container {
      background: #fff;
      border: 2px inset var(--win-dark);
      height: 24px;
      margin-top: 8px;
      display: flex;
      padding: 2px;
      gap: 1px;
      justify-content: flex-start;
    }
    
    .progress-segment {
      width: 8px;
      height: 100%;
      background: var(--win-gray);
    }
    
    .progress-segment.active {
      background: var(--primary-blue);
    }
    
    .win95-inset {
      border: 2px inset var(--win-dark);
      background: var(--win-gray);
      padding: 6px;
      margin-bottom: 6px;
    }
    
    .win95-list {
      border: 2px inset var(--win-dark);
      background: #fff;
      padding: 4px;
      font-family: 'Courier New', monospace;
      height: 100px;
      overflow-y: auto;
    }
    
    .list-item {
      padding: 8px 6px;
      cursor: pointer;
      user-select: none;
      font-size: 13px;
    }
    
    .list-item:hover {
      background: var(--primary-blue);
      color: white;
      transition: background 0.2s ease;
    }
    
    .list-item.selected {
      background: var(--primary-blue);
      color: white;
    }
    
    .preview-container {
      margin-bottom: 20px;
      border: 2px inset var(--win-dark);
      padding: 10px;
      background: #e0e0e0;
    }
    
    .wave-title {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-bottom: 6px;
      word-break: break-word;
      font-weight: bold;
      text-align: center;
    }
    
    .wave-element {
      width: 100%;
      height: 150px;
      background: #000;
      margin-bottom: 10px;
    }
    
    .wave-button {
      margin-top: 6px;
      font-family: 'Courier New', monospace;
      padding: 8px;
      background: var(--win-gray);
      border: 2px outset var(--win-gray);
      cursor: pointer;
      width: 100%;
    }
    
    .wave-button:active {
      border-style: inset;
    }
    
    .render-error {
      color: red;
      font-size: 13px;
      padding: 10px;
      background: #ffe6e6;
      border: 1px solid #ff9999;
    }
    
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--win-gray);
      height: 36px;
      border-top: 2px solid var(--win-light);
      display: flex;
      align-items: center;
      padding: 0 8px;
      z-index: 90;
    }
    
    .start-button {
      padding: 4px 8px;
      background: var(--win-gray);
      border: 2px outset var(--win-gray);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .start-button:active {
      border-style: inset;
    }
    
    .status-bar {
      margin-left: auto;
      padding: 0 8px;
      font-size: 14px;
    }
    
    .window-controls {
      display: flex;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .button-group button {
      flex: 1;
    }
    
    #cancel-button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background: var(--win-gray);
      border: 2px outset var(--win-gray);
      color: #000;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      cursor: pointer;
    }
    
    #cancel-button:active {
      border-style: inset;
    }
    
    .supported-formats {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }
    
    .file-error {
      color: #d32f2f;
      background-color: #ffcdd2;
      border: 1px solid #f44336;
      padding: 8px;
      margin: 8px 0;
      border-radius: 2px;
      font-size: 13px;
    }
    
    .memory-warning {
      color: #ff6f00;
      background-color: #fff3e0;
      border: 1px solid #ff9800;
      padding: 8px;
      margin: 8px 0;
      border-radius: 2px;
      font-size: 13px;
      display: none;
    }
    
    .mobile-warning {
      color: #1976d2;
      background-color: #bbdefb;
      border: 1px solid #2196f3;
      padding: 8px;
      margin: 8px 0;
      border-radius: 2px;
      font-size: 13px;
      display: none;
    }
    
    .info-panel {
      background: #fff;
      border: 2px inset var(--win-dark);
      padding: 10px;
      margin-top: 10px;
      font-size: 13px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .trim-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    
    .preview-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .preview-list {
      border: 2px inset var(--win-dark);
      background: #fff;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .preview-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid var(--win-gray);
    }
    
    .preview-item:hover {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .preview-item.active {
      background-color: var(--primary-blue);
      color: white;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="desktop-icon" style="top: 20px; left: 30px;" onclick="document.querySelector('.window').style.display = 'block'">
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij4KICA8cmVjdCB4PSIyNCIgeT0iNDAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iI2U1MzkzNSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPHJlY3QgeD0iMjYiIHk9IjQ0IiB3aWR0aD0iMTIiIGhlaWdodD0iNCIgZmlsbD0iI2I3MWMxYyIvPgogIDxwb2x5Z29uIHBvaW50cz0iMzIsMzIgMjgsMjggMzAsMjQgMzQsMjYgMzYsMjIgMzgsMzAiIGZpbGw9Im9yYW5nZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg==" 
         width="48" height="48">
    <div>KO II Tool</div>
  </div>
  
  <div class="window">
    <div class="title-bar">
      <span>SpeedUpperCut</span>
      <div class="window-controls">
        <button class="minimize" title="Minimize">_</button>
        <button class="close" title="Close">×</button>
      </div>
    </div>
    <div class="content">
      <div class="memory-warning" id="memory-warning">
        <i class="fas fa-exclamation-triangle"></i>
        Processing large files may use significant memory. Close other tabs for best performance.
      </div>
      
      <div class="mobile-warning" id="mobile-warning">
        <i class="fas fa-mobile-alt"></i>
        Processing on mobile may be slow. Use small files for best results.
      </div>
      
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <div class="win95-inset" style="flex: 1;">
          <label>FIDELITY</label><br>
          <div class="win95-list" data-group="fidelity">
            <div data-value="cd" class="list-item selected">CD (16-bit, 44.1kHz)</div>
            <div data-value="sp8" class="list-item">SP-1200 (8-bit, 22kHz)</div>
            <div data-value="sp16" class="list-item">SP-1200 (16-bit, 22kHz)</div>
            <div data-value="sk" class="list-item">SK-1 (8-bit, 9kHz)</div>
          </div>
        </div>
        <div class="win95-inset" style="flex: 1;">
          <label>CHANNELS</label><br>
          <div class="win95-list" data-group="channels">
            <div data-value="stereo" class="list-item selected">Stereo</div>
            <div data-value="mono" class="list-item">Mono</div>
          </div>
        </div>
      </div>
      
      <div class="trim-control">
        <input type="checkbox" id="auto-trim" checked style="width: 16px; height: 16px;">
        <label for="auto-trim">Auto-trim silence at start/end</label>
      </div>
      
      <div class="drop-zone" id="drop-zone">
        <i class="fas fa-cloud-upload-alt" style="font-size: 36px;"></i>
        <input type="file" id="audio-upload" accept=".wav,.mp3,.aac,.ogg,.flac,audio/*" multiple />
        <input type="file" id="folder-upload" webkitdirectory directory multiple style="display: none;" />
        <span>DRAG AND DROP OR SELECT AUDIO FILES/FOLDERS</span>
        <div class="supported-formats">
          Supported: WAV, MP3, AAC, OGG, FLAC
        </div>
      </div>
      
      <div class="button-group">
        <button id="select-file-button">Select Files</button>
        <button id="select-folder-button">Select Folder</button>
        <button id="clear-button">Clear List</button>
        <button id="preview-button" style="display: none;">Preview Results</button>
      </div>
      
      <div class="info-panel" id="file-info">
        <div>Drop or select audio files/folders to process</div>
        <div>Files will be sped up 2x to save space</div>
        <div>Auto-trim removes silence at start and end</div>
        <div>Folder structure will be preserved in output</div>
        <div>Note: Original MP3/OGG files may increase in size when converted to WAV</div>
      </div>
    </div>
  </div>

  <div class="preview-window" id="preview-window">
    <div class="title-bar">
      <span>Preview Processed Audio</span>
      <div class="window-controls">
        <button class="minimize" title="Minimize">_</button>
        <button class="close" title="Close">×</button>
      </div>
    </div>
    <div class="content">
      <div class="preview-container">
        <div class="wave-element" id="wave-preview"></div>
        
        <div class="preview-header">
          <div class="wave-title" id="preview-title">Select a file to preview</div>
          <button id="close-preview">Close Preview</button>
        </div>
        
        <div class="preview-controls">
          <button class="wave-button" id="play-button">
            <i class="fas fa-play"></i> Play
          </button>
          <button class="wave-button" id="pause-button" style="display: none;">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="wave-button" id="stop-button">
            <i class="fas fa-stop"></i> Stop
          </button>
        </div>
        
        <div class="preview-list" id="preview-list">
          <!-- Preview items will be added here -->
        </div>
      </div>
    </div>
  </div>

  <div id="overlay">
    <div id="win95-loader">
      <div id="processing-title">Processing Audio Files...</div>
      <div class="progress-bar-container" id="segment-container"></div>
      <div id="current-file">Preparing...</div>
      <button id="cancel-button">Cancel Processing</button>
    </div>
  </div>

  <div class="taskbar">
    <div class="start-button">
      <i class="fas fa-bars"></i> Start
    </div>
    <div class="status-bar" id="status-bar">Ready</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.js"></script>
  <script>
    const waveformQueue = [];
    let activeAudioContext = null;
    let createdObjectURLs = [];
    let dragCounter = 0;
    let processingCancelled = false;
    let currentProcessing = null;
    let lastProgress = 0;
    let previewFiles = [];
    let wavesurfer = null;
    let audioContextInitialized = false;
    let memoryWarningShown = false;
    let isProcessing = false;

    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });

    function isMobile() {
      return ('ontouchstart' in window) || 
             (navigator.maxTouchPoints > 0) || 
             (navigator.msMaxTouchPoints > 0);
    }

    function initApp() {
      if (isMobile()) {
        document.getElementById('mobile-warning').style.display = 'block';
      }
      
      checkMemoryAndWarn();
      
      document.querySelectorAll('.win95-list').forEach(group => {
        group.addEventListener('click', e => {
          if (e.target.classList.contains('list-item')) {
            group.querySelectorAll('.list-item').forEach(item => {
              item.classList.remove('selected');
            });
            e.target.classList.add('selected');
            updateStatus(`Fidelity set to: ${e.target.textContent}`);
          }
        });
      });

      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('audio-upload');
      const folderInput = document.getElementById('folder-upload');
      const selectFileButton = document.getElementById('select-file-button');
      const selectFolderButton = document.getElementById('select-folder-button');
      const clearButton = document.getElementById('clear-button');
      const cancelButton = document.getElementById('cancel-button');
      const previewButton = document.getElementById('preview-button');
      const closePreviewButton = document.getElementById('close-preview');
      const playButton = document.getElementById('play-button');
      const pauseButton = document.getElementById('pause-button');
      const stopButton = document.getElementById('stop-button');

      dropZone.addEventListener('dragover', handleDragOver);
      dropZone.addEventListener('dragleave', handleDragLeave);
      dropZone.addEventListener('drop', handleDrop);
      
      dropZone.addEventListener('touchmove', e => {
        e.preventDefault();
        dragCounter++;
        dropZone.classList.add('dragover');
      }, {passive: false});
      
      dropZone.addEventListener('touchend', handleDragLeave);
      
      selectFileButton.addEventListener('click', () => fileInput.click());
      selectFolderButton.addEventListener('click', () => folderInput.click());
      clearButton.addEventListener('click', () => {
        document.getElementById('file-info').innerHTML = 
          '<div>Drop or select audio files/folders to process</div>' +
          '<div>Files will be sped up 2x to save space</div>' +
          '<div>Auto-trim removes silence at start and end</div>' +
          '<div>Folder structure will be preserved in output</div>' +
          '<div>Note: Original MP3/OGG files may increase in size when converted to WAV</div>';
        updateStatus("File list cleared");
      });
      
      previewButton.addEventListener('click', () => {
        initPreviewWindow();
      });
      
      closePreviewButton.addEventListener('click', () => {
        closePreviewWindow();
      });
      
      playButton.addEventListener('click', () => {
        if (wavesurfer) {
          wavesurfer.play();
          playButton.style.display = 'none';
          pauseButton.style.display = 'block';
        }
      });
      
      pauseButton.addEventListener('click', () => {
        if (wavesurfer) {
          wavesurfer.pause();
          pauseButton.style.display = 'none';
          playButton.style.display = 'block';
        }
      });
      
      stopButton.addEventListener('click', () => {
        if (wavesurfer) {
          wavesurfer.stop();
          pauseButton.style.display = 'none';
          playButton.style.display = 'block';
        }
      });
      
      fileInput.addEventListener('change', (e) => {
        processFiles(e.target.files);
        e.target.value = null;
      });
      
      folderInput.addEventListener('change', (e) => {
        processFolder(e.target.files);
        e.target.value = null;
      });
      
      document.querySelector('.title-bar .minimize').addEventListener('click', () => {
        document.querySelector('.window').style.display = 'none';
      });
      
      document.querySelector('.title-bar .close').addEventListener('click', () => {
        document.querySelector('.window').style.display = 'none';
      });
      
      document.querySelector('#preview-window .minimize').addEventListener('click', () => {
        document.getElementById('preview-window').style.display = 'none';
      });
      
      document.querySelector('#preview-window .close').addEventListener('click', () => {
        closePreviewWindow();
      });
      
      cancelButton.addEventListener('click', () => {
        processingCancelled = true;
        if (currentProcessing) {
          currentProcessing.cancel();
        }
        hideOverlay();
        updateStatus("Processing cancelled");
      });
      
      updateStatus("Ready to process files");
    }
    
    function closePreviewWindow() {
      document.getElementById('preview-window').style.display = 'none';
      if (wavesurfer) {
        wavesurfer.stop();
        try {
          const audioEl = wavesurfer.getMediaElement();
          const url = audioEl?.src;
          if (url) try { URL.revokeObjectURL(url); } catch(e) {}
        } catch (e) {}
        try { wavesurfer.destroy(); } catch(e) {}
        wavesurfer = null;
      }
      playButton.style.display = 'block';
      pauseButton.style.display = 'none';
    }
    
    function checkMemoryAndWarn() {
      if (memoryWarningShown) return;
      
      if (performance?.memory) {
        const totalJSHeapSize = performance.memory.totalJSHeapSize;
        const jsHeapSizeLimit = performance.memory.jsHeapSizeLimit;
        if (totalJSHeapSize > jsHeapSizeLimit * 0.7) {
          document.getElementById('memory-warning').style.display = 'block';
          memoryWarningShown = true;
        }
      } else if (navigator.deviceMemory && navigator.deviceMemory < 4) {
        document.getElementById('memory-warning').style.display = 'block';
        memoryWarningShown = true;
      }
    }

    function updateStatus(message) {
      document.getElementById('status-bar').textContent = message;
    }

    function updateCurrentFile(message) {
      const currentFileElement = document.getElementById('current-file');
      if (currentFileElement) {
        currentFileElement.textContent = message;
      }
    }

    function updateFileInfo(message) {
      const fileInfo = document.getElementById('file-info');
      if (!fileInfo) return;
      if (/<[a-z][\s\S]*>/i.test(message)) {
        fileInfo.insertAdjacentHTML('beforeend', message);
      } else {
        const div = document.createElement('div');
        div.textContent = message;
        fileInfo.appendChild(div);
      }
      fileInfo.scrollTop = fileInfo.scrollHeight;
    }

    function showOverlay() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('win95-loader').style.display = 'block';
      processingCancelled = false;
      lastProgress = 0;
    }

    function hideOverlay() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('win95-loader').style.display = 'none';
    }

    function handleDragOver(e) {
      e.preventDefault();
      dragCounter++;
      document.getElementById('drop-zone').class极长的代码，后续部分在下一个消息中发送