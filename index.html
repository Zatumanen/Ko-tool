<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>SpeedUpperCut</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="24" y="40" width="16" height="16" fill="%23e53935" stroke="black" stroke-width="2"/><rect x="26" y="44" width="12" height="4" fill="%23b71c1c"/><polygon points="32,32 28,28 30,24 34,26 36,22 38,30" fill="orange" stroke="black" stroke-width="1"/></svg>'>
<style>
:root{--glow-color:#ff3333;--primary-blue:#000080;--win-gray:#c0c0c0;--win-light:#ffffff;--win-dark:#808080;}
body{background:#008080;font-family:'Courier New',monospace;margin:0;padding:20px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;overflow-x:hidden;background-image:radial-gradient(circle at 1px 1px,var(--win-dark) 1px,transparent 0),radial-gradient(circle at 1px 1px,var(--win-dark) 1px,transparent 0);background-size:4px 4px;background-position:0 0,2px 2px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
.desktop-icon{position:absolute;width:80px;text-align:center;color:#fff;text-shadow:1px 1px 1px #000;cursor:pointer;padding:4px;user-select:none;transition:transform .2s}.desktop-icon:hover{background:rgba(255,255,255,.2);transform:scale(1.05)}
.window{width:100%;max-width:480px;background:var(--win-gray);border:2px solid;border-top-color:var(--win-light);border-left-color:var(--win-light);border-right-color:var(--win-dark);border-bottom-color:var(--win-dark);box-shadow:2px 2px 4px rgba(0,0,0,.5);padding:0;box-sizing:border-box;position:relative;z-index:100;}
.title-bar{background:var(--primary-blue);color:#fff;padding:4px 8px;font-size:14px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--win-gray);cursor:move;user-select:none;}
.title-bar button{width:20px;height:20px;border:none;background:var(--win-gray);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-left:4px;border:1px outset}.title-bar button:active{border-style:inset}
.content{padding:12px;font-size:14px;color:#000}
.drop-zone{border:2px dashed #000;padding:20px;text-align:center;background:rgba(255,255,255,.3);margin-top:12px;position:relative;cursor:pointer;border-style:dotted;border-color:var(--win-dark)}
.drop-zone.dragover{background:rgba(0,128,0,.3)}
.drop-zone input[type=file]{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer}
.drop-zone span{pointer-events:none;font-size:16px;display:block;margin-top:10px}
.supported-formats{font-size:12px;color:#666;margin-top:4px}
#file-info{margin-top:10px;font-size:14px;background:#fff;border:2px inset var(--win-dark);padding:10px;max-height:200px;overflow-y:auto}
button{min-height:44px;padding:10px;cursor:pointer;font-family:'Courier New',monospace;font-size:16px;border:2px outset var(--win-gray);background:var(--win-gray)}
button:active{border-style:inset}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000}
#win95-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;padding:12px;background:var(--win-gray);font-family:'Courier New',monospace;font-size:14px;color:#000;z-index:1001;border:2px outset}
.progress-bar-container{background:#fff;border:2px inset;height:24px;margin-top:8px;display:flex;padding:2px;gap:1px}
.progress-segment{width:8px;height:100%;background:var(--win-gray)}
.progress-segment.active{background:var(--primary-blue)}
.win95-inset{border:2px inset var(--win-dark);background:var(--win-gray);padding:6px;margin-bottom:6px}
.win95-list{border:2px inset var(--win-dark);background:#fff;padding:4px;font-family:'Courier New',monospace;height:100px;overflow-y:auto}
.list-item{padding:8px 6px;cursor:pointer;user-select:none;font-size:13px}
.list-item:hover,.list-item.selected{background:var(--primary-blue);color:#fff}
.trim-control{display:flex;align-items:center;gap:8px;margin:10px 0}
.wave-window{position:absolute;width:500px;background:var(--win-gray);border:2px solid;border-top-color:var(--win-light);border-left-color:var(--win-light);border-right-color:var(--win-dark);border-bottom-color:var(--win-dark);box-shadow:2px 2px 4px rgba(0,0,0,.5);padding:0;box-sizing:border-box;z-index:101;top:100px;left:100px}
.preview-controls{display:flex;gap:10px;justify-content:center;margin-top:10px}
.taskbar{position:fixed;bottom:0;left:0;right:0;background:var(--win-gray);height:36px;border-top:2px solid var(--win-light);display:flex;align-items:center;padding:0 8px;z-index:90}
.start-button{padding:4px 8px;background:var(--win-gray);border:2px outset;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:4px}
.start-button:active{border-style:inset}
.status-bar{margin-left:auto;padding:0 8px;font-size:14px}
@media(max-width:768px){body{padding:10px}.window{width:95vw}.wave-window{width:90vw;left:5vw;top:20px}}
</style>
</head>
<body>
<div class="desktop-icon" style="top:20px;left:30px" onclick="document.getElementById('mainWin').style.display='block'">
  <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij4KICA8cmVjdCB4PSIyNCIgeT0iNDAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iI2U1MzkzNSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPHJlY3QgeD0iMjYiIHk9IjQ0IiB3aWR0aD0iMTIiIGhlaWdodD0iNCIgZmlsbD0iI2I3MWMxYyIvPgogIDxwb2x5Z29uIHBvaW50cz0iMzIsMzIgMjgsMjggMzAsMjQgMzQsMjYgMzYsMjIgMzgsMzAiIGZpbGw9Im9yYW5nZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg==" width="48" height="48">
  <div>KO II Tool</div>
</div>

<div class="window" id="mainWin">
  <div class="title-bar">
    <span>SpeedUpperCut</span>
    <div class="window-controls">
      <button class="minimize" onclick="mainWin.style.display='none'">_</button>
      <button class="close" onclick="mainWin.style.display='none'">×</button>
    </div>
  </div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <div class="win95-inset" style="flex:1">
        <label>FIDELITY</label><br>
        <div class="win95-list" data-group="fidelity">
          <div data-value="cd" class="list-item selected">CD (16-bit, 44.1kHz)</div>
          <div data-value="sp8" class="list-item">SP-1200 (8-bit, 22kHz)</div>
          <div data-value="sp16" class="list-item">SP-1200 (16-bit, 22kHz)</div>
          <div data-value="sk" class="list-item">SK-1 (8-bit, 9kHz)</div>
        </div>
      </div>
      <div class="win95-inset" style="flex:1">
        <label>CHANNELS</label><br>
        <div class="win95-list" data-group="channels">
          <div data-value="stereo" class="list-item selected">Stereo</div>
          <div data-value="mono" class="list-item">Mono</div>
        </div>
      </div>
    </div>
    <div class="trim-control">
      <input type="checkbox" id="auto-trim" checked style="width:16px;height:16px">
      <label for="auto-trim">Auto-trim silence at start/end</label>
    </div>
    <div class="drop-zone" id="drop-zone">
      <i class="fas fa-cloud-upload-alt" style="font-size:36px"></i>
      <input type="file" id="audio-upload" multiple accept=".wav,.mp3,.aac,.ogg,.flac,audio/*">
      <input type="file" id="folder-upload" webkitdirectory directory multiple style="display:none">
      <span>DRAG AND DROP OR SELECT AUDIO FILES/FOLDERS</span>
      <div class="supported-formats">Supported: WAV, MP3, AAC, OGG, FLAC</div>
    </div>
    <div class="button-group">
      <button id="select-file-button">Select Files</button>
      <button id="select-folder-button">Select Folder</button>
      <button id="clear-button">Clear List</button>
    </div>
    <div id="file-info">
      <div>Drop or select audio files/folders to process</div>
      <div>Files will be sped up 2× to save space</div>
      <div>Auto-trim removes silence at start and end</div>
      <div>Folder structure will be preserved in output</div>
      <div>Files will be saved in their original format</div>
      <div>KO II will convert files during import</div>
    </div>
  </div>
</div>

<div id="overlay">
  <div id="win95-loader">
    <div id="processing-title">Processing Audio Files...</div>
    <div class="progress-bar-container" id="segment-container"></div>
    <div id="current-file">Preparing...</div>
    <button id="cancel-button">Cancel Processing</button>
  </div>
</div>

<div class="taskbar">
  <div class="start-button"><i class="fas fa-bars"></i> Start</div>
  <div class="status-bar" id="status-bar">Ready</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7"></script>
<script>
/* ---------- КОНСТАНТЫ ---------- */
const MIN_DURATION = 0.5;  // фикс SK-1 + mono
const maxPreview = 5;
let activeAudioContext = null;
let createdObjectURLs = [];
let processingCancelled = false;
let waveWindows = [];

/* ---------- УТИЛИТЫ ---------- */
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function log(msg, cls = '') {
  const fi = $('#file-info');
  fi.insertAdjacentHTML('beforeend', `<div${cls ? ' class="' + cls + '"' : ''}>${msg}</div>`);
  fi.scrollTop = fi.scrollHeight;
}
function setStatus(msg) { $('#status-bar').textContent = msg; }

/* ---------- AUDIO CONTEXT ---------- */
async function getCtx() {
  if (!activeAudioContext) activeAudioContext = new (window.AudioContext || webkitAudioContext)();
  if (activeAudioContext.state === 'suspended') await activeAudioContext.resume();
  return activeAudioContext;
}

/* ---------- ОБРАБОТКА ФАЙЛОВ ---------- */
async function processFiles(files) {
  if (!files.length) return;
  const items = [...files].map(f => ({ file: f, path: f.name }));
  await processItems(items);
}
async function processFolder(files) {
  if (!files.length) return;
  const items = [...files].map(f => ({ file: f, path: f.webkitRelativePath || f.name }));
  await processItems(items);
}
async function processItems(items) {
  if (!items.length) return;
  $('#overlay').style.display = 'block';
  processingCancelled = false;
  const zip = new JSZip();
  const segmentContainer = $('#segment-container');
  segmentContainer.innerHTML = '';
  for (let i = 0; i < 50; i++) {
    const s = document.createElement('div');
    s.className = 'progress-segment';
    segmentContainer.appendChild(s);
  }
  const segs = [...segmentContainer.children];
  let processed = 0, totalOriginal = 0, totalProcessed = 0, totalTrimmed = 0;
  const fidelity = $('#fidelity .selected').dataset.value;
  const channels = $('#channels .selected').dataset.value;
  const autoTrim = $('#auto-trim').checked;

  for (const { file, path } of items) {
    if (processingCancelled) break;
    $('#current-file').textContent = `Processing: ${path} (${processed + 1}/${items.length})`;
    try {
      await getCtx();
      const ab = await file.arrayBuffer();
      const buf = await activeAudioContext.decodeAudioData(ab.slice(0));
      let procBuf = await convertChannels(buf, channels);
      procBuf = await applySpeedAndFidelity(procBuf, 2, fidelity);
      if (autoTrim) {
        const before = procBuf.length;
        procBuf = trimSilence(procBuf);
        totalTrimmed += before - procBuf.length;
      }
      const ext = (file.name.split('.').pop() || 'wav').toLowerCase();
      const newName = path.replace(/\.[^/.]+$/, '') + '_ko2.' + ext;
      const outBlob = await encodeToOriginalFormat(procBuf, ext);
      zip.file(newName, outBlob);
      const previewURL = URL.createObjectURL(outBlob);
      createdObjectURLs.push(previewURL);
      createWaveWindow(newName, previewURL, procBuf);
      processed++;
      totalOriginal += file.size;
      totalProcessed += outBlob.size;
      segs.forEach((s, i) => s.classList.toggle('active', i < processed / items.length * 50));
    } catch (err) {
      log(`<div class="file-error">${path}: ${err.message}</div>`);
    }
  }
  if (!processingCancelled && processed) {
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(zipBlob);
    createdObjectURLs.push(url);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ko2_processed_audio.zip';
    a.click();
    log(`<b>Processed:</b> ${processed} files`);
    log(`<b>Original size:</b> ${(totalOriginal / 1024 / 1024).toFixed(2)} MB`);
    log(`<b>Processed size:</b> ${(totalProcessed / 1024 / 1024).toFixed(2)} MB`);
    log(`<b>Space saved:</b> ${((1 - totalProcessed / totalOriginal) * 100).toFixed(1)} %`);
    if (autoTrim && totalTrimmed)
      log(`<b>Silence trimmed:</b> ${(totalTrimmed / 44100).toFixed(2)} s`);
  }
  $('#overlay').style.display = 'none';
}

/* ---------- КОДИРОВАНИЕ В ИСХОДНЫЙ ФОРМАТ ---------- */
async function encodeToOriginalFormat(buffer, ext) {
  switch (ext) {
    case 'mp3': return audioBufferToMp3(buffer);
    default: return audioBufferToWav(buffer);
  }
}
function audioBufferToWav(buffer) {
  const len = buffer.length * buffer.numberOfChannels * 2;
  const b = new ArrayBuffer(44 + len);
  const v = new DataView(b);
  const writeStr = (o, s) => [...s].forEach((c, i) => v.setUint8(o + i, c.charCodeAt()));
  writeStr(0, 'RIFF');
  v.setUint32(4, 36 + len, true);
  writeStr(8, 'WAVEfmt ');
  v.setUint32(16, 16, true);
  v.setUint16(20, 1, true);
  v.setUint16(22, buffer.numberOfChannels, true);
  v.setUint32(24, buffer.sampleRate, true);
  v.setUint32(28, buffer.sampleRate * buffer.numberOfChannels * 2, true);
  v.setUint16(32, buffer.numberOfChannels * 2);
  v.setUint16(34, 16, true);
  writeStr(36, 'data');
  v.setUint32(40, len, true);
  let offset = 44;
  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < buffer.numberOfChannels; c++) {
      const s = Math.max(-1, Math.min(1, buffer.getChannelData(c)[i]));
      v.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      offset += 2;
    }
  }
  return new Blob([b], { type: 'audio/wav' });
}
function audioBufferToMp3(buffer) {
  const channels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const mp3enc = new lamejs.Mp3Encoder(channels, sampleRate, 192);
  const samples = new Int16Array(buffer.length * channels);
  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < channels; c++) {
      const s = Math.max(-1, Math.min(1, buffer.getChannelData(c)[i]));
      samples[i * channels + c] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
  }
  const mp3Data = [];
  const blockSize = 1152;
  for (let i = 0; i < samples.length; i += blockSize * channels) {
    const left = samples.subarray(i, i + blockSize);
    const right = channels > 1 ? samples.subarray(i + blockSize, i + 2 * blockSize) : left;
    const mp3buf = mp3enc.encodeBuffer(left, right);
    if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
  }
  const end = mp3enc.flush();
  if (end.length > 0) mp3Data.push(new Int8Array(end));
  return new Blob(mp3Data, { type: 'audio/mp3' });
}

/* ---------- КОНВЕРТАЦИЯ КАНАЛОВ / СКОРОСТЬ ---------- */
async function convertChannels(buffer, target) {
  const targetCh = target === 'mono' ? 1 : 2;
  if (buffer.numberOfChannels === targetCh) return buffer;
  const Offline = window.OfflineAudioContext || webkitOfflineAudioContext;
  const ctx = new Offline(targetCh, buffer.length, buffer.sampleRate);
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  src.connect(ctx.destination);
  src.start();
  return ctx.startRendering();
}
async function applySpeedAndFidelity(buffer, speed, fidelity) {
  const map = { cd: 44100, sp8: 22050, sp16: 22050, sk: 9000 };
  const sr = map[fidelity] || 44100;
  const dur = Math.max(buffer.duration / speed, MIN_DURATION);
  const Offline = window.OfflineAudioContext || webkitOfflineAudioContext;
  const ctx = new Offline(buffer.numberOfChannels, dur * sr, sr);
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  src.playbackRate.value = speed;
  src.connect(ctx.destination);
  src.start();
  return ctx.startRendering();
}
function trimSilence(buffer, thresholdDb = -60, minDur = 0.1) {
  const th = 10 ** (thresholdDb / 20);
  const sr = buffer.sampleRate;
  const ch = buffer.getChannelData(0);
  let start = 0, end = ch.length - 1;
  for (let i = 0; i < ch.length; i++) if (Math.abs(ch[i]) > th) { start = i; break; }
  for (let i = ch.length - 1; i >= 0; i--) if (Math.abs(ch[i]) > th) { end = i; break; }
  if (start >= end) return buffer;
  const len = end - start + 1;
  const nb = new AudioBuffer({ length: len, numberOfChannels: buffer.numberOfChannels, sampleRate: sr });
  for (let c = 0; c < buffer.numberOfChannels; c++) {
    nb.copyToChannel(buffer.getChannelData(c).subarray(start, end + 1), c);
  }
  return nb;
}

/* ---------- ВИЗУАЛИЗАЦИЯ ---------- */
function createWaveWindow(title, url, buf) {
  if (waveWindows.length >= 5) {
    const old = waveWindows.shift();
    try { old.win.remove(); URL.revokeObjectURL(old.url); } catch {}
  }
  const win = document.createElement('div');
  win.className = 'wave-window';
  win.style.zIndex = 100 + waveWindows.length * 2;
  win.style.top = 80 + waveWindows.length * 30 + 'px';
  win.style.left = 100 + waveWindows.length * 30 + 'px';
  win.innerHTML = `
    <div class="title-bar">
      <span>${title}</span>
      <div class="window-controls">
        <button class="minimize" onclick="this.closest('.wave-window').querySelector('.content').style.display='none'">_</button>
        <button class="close" onclick="this.closest('.wave-window').remove()">×</button>
      </div>
    </div>
    <div class="content">
      <div class="wave-container">
        <div class="wave-title">${title}</div>
        <div class="wave-element-container"><div class="wave-element"></div></div>
        <div class="preview-controls">
          <button class="wave-button play-button"><i class="fas fa-play"></i> Play</button>
          <button class="wave-button stop-button"><i class="fas fa-stop"></i> Stop</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(win);
  const ws = WaveSurfer.create({ container: win.querySelector('.wave-element'), height: 150, backend: 'MediaElement' });
  ws.load(url);
  win.querySelector('.play-button').onclick = () => ws.play();
  win.querySelector('.stop-button').onclick = () => ws.stop();
  makeDraggable(win);
  waveWindows.push({ win, url });
}
function makeDraggable(el) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  el.querySelector('.title-bar').addEventListener('mousedown', e => {
    e.preventDefault();
    pos3 = e.clientX; pos4 = e.clientY;
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stop);
    function drag(e) {
      el.style.top = (el.offsetTop - e.clientY + pos4) + 'px';
      el.style.left = (el.offsetLeft - e.clientX + pos3) + 'px';
      pos3 = e.clientX; pos4 = e.clientY;
    }
    function stop() { document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stop); }
  });
}

/* ---------- ОЧИСТКА ---------- */
function clearList() {
  $('#file-info').innerHTML = `
    <div>Drop or select audio files/folders to process</div>
    <div>Files will be sped up 2× to save space</div>
    <div>Auto-trim removes silence at start and end</div>
    <div>Folder structure will be preserved in output</div>
    <div>Files will be saved in their original format</div>
    <div>KO II will convert files during import</div>
  `;
  setStatus('Ready');
}

/* ---------- ИНИЦИАЛИЗАЦИЯ ---------- */
document.addEventListener('DOMContentLoaded', () => {
  $$('.win95-list').forEach(group => {
    group.addEventListener('click', e => {
      if (!e.target.classList.contains('list-item')) return;
      group.querySelectorAll('.list-item').forEach(i => i.classList.remove('selected'));
      e.target.classList.add('selected');
      setStatus(`Fidelity set to: ${e.target.textContent}`);
    });
  });
  $('#select-file-button').onclick = () => { document.getElementById('audio-upload').click(); };
  $('#select-folder-button').onclick = () => { document.getElementById('folder-upload').click(); };
  $('#clear-button').onclick = clearList;
  $('#cancel-button').onclick = () => processingCancelled = true;
  const dz = $('#drop-zone');
  let dragCounter = 0;
  ['dragover','dragenter'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dragCounter++; dz.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dragCounter--; if (dragCounter<=0) dz.classList.remove('dragover'); if (e.type==='drop') handleDrop(e); }));
  document.getElementById('audio-upload').addEventListener('change', e => processFiles(e.target.files));
  document.getElementById('folder-upload').addEventListener('change', e => processFolder(e.target.files));
});

function handleDrop(e){
  if(e.dataTransfer.items){
    const queue=[],items=[];
    [...e.dataTransfer.items].forEach(item=>{
      const entry=item.webkitGetAsEntry?.()||item.getAsFile?.();
      if(entry)queue.push({entry,path:''});
    });
    processQueue(queue,items);
  }else if(e.dataTransfer.files.length){
    processItems([...e.dataTransfer.files].map(f=>({file:f,path:f.name})));
  }
}
function processQueue(q,i){
  if(!q.length){processItems(i);return}
  const {entry,path}=q.shift();
  if(!entry){processQueue(q,i);return}
  if(entry.isFile){
    entry.file(f=>{i.push({file:f,path:path+f.name});processQueue(q,i)});
  }else if(entry.isDirectory){
    entry.createReader().readEntries(e=>{e.forEach(en=>q.push({entry:en,path:path+entry.name+'/'}));processQueue(q,i)});
  }else processQueue(q,i);
}

window.addEventListener('beforeunload', () => {
  createdObjectURLs.forEach(u => { try { URL.revokeObjectURL(u); } catch {} });
  if (activeAudioContext) try { activeAudioContext.close(); } catch {}
});
</script>
</body>
</html>
