<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KO II Audio Tool v2.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Стили без изменений */
  </style>
</head>
<body>
  <!-- HTML без изменений -->

  <script>
    // ... весь предыдущий код без изменений до функции renderWaveform ...

    // Визуализация волны
    function renderWaveform(audioBuffer, filename) {
      return new Promise((resolve) => {
        // Создание контейнера
        const container = document.createElement('div');
        container.className = 'wave-container';
        
        // Заголовок
        const title = document.createElement('div');
        title.className = 'wave-title';
        try {
          title.textContent = decodeURIComponent(filename);
        } catch {
          title.textContent = filename;
        }
        
        // Контейнер волны
        const wave = document.createElement('div');
        wave.className = 'wave-element';
        
        // Кнопка воспроизведения
        const button = document.createElement('button');
        button.className = 'wave-button';
        button.innerHTML = '<i class="fas fa-play"></i> Play Processed Audio';
        
        // Добавление элементов
        container.appendChild(title);
        container.appendChild(wave);
        container.appendChild(button);
        document.getElementById('waveform-list').appendChild(container);
        
        try {
          // Инициализация Wavesurfer
          const wavesurfer = WaveSurfer.create({
            container: wave,
            waveColor: '#0f0',
            progressColor: '#ff0',
            height: 100,
            barWidth: 2,
            minPxPerSec: 100,
            cursorColor: '#f00',
            sampleRate: audioBuffer.sampleRate
          });

          // Обработка готовности
          wavesurfer.on('ready', () => {
            button.addEventListener('click', () => {
              if (wavesurfer.isPlaying()) {
                wavesurfer.pause();
                button.innerHTML = '<i class="fas fa-play"></i> Play Processed Audio';
                updateStatus("Playback paused");
              } else {
                wavesurfer.play();
                button.innerHTML = '<i class="fas fa-pause"></i> Pause';
                updateStatus("Playing processed audio");
              }
            });
            resolve();
          });

          // Обработка ошибок
          wavesurfer.on('error', (err) => {
            console.error('Wavesurfer error:', err);
            wave.innerHTML = '<div class="render-error">Render failed: ' + err.message + '</div>';
            resolve();
          });

          // ИСПРАВЛЕНИЕ: Создаем WAV-файл из буфера и загружаем его
          const wavBlob = audioBufferToWav(audioBuffer);
          const url = URL.createObjectURL(wavBlob);
          
          wavesurfer.load(url);
          
          // Сохраняем URL для последующей очистки
          createdObjectURLs.push(url);
        } catch (err) {
          console.error('Wavesurfer init error:', err);
          wave.innerHTML = '<div class="render-error">Init failed: ' + err.message + '</div>';
          resolve();
        }
      });
    }

    // ... остальной код без изменений ...
  </script>
</body>
</html>