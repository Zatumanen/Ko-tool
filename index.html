<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpeedUpperCut</title>
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="24" y="40" width="16" height="16" fill="%23e53935" stroke="black" stroke-width="2"/><rect x="26" y="44" width="12" height="4" fill="%23b71c1c"/><polygon points="32,32 28,28 30,24 34,26 36,22 38,30" fill="orange" stroke="black" stroke-width="1"/></svg>'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--bg:#008080;--win:#c0c0c0;--accent:#000080}
    html,body{height:100%;margin:0;font-family:Courier,monospace;background:var(--bg);padding:18px;box-sizing:border-box;overflow-x:hidden}
    .desktop-icon{position:absolute;left:30px;top:20px;width:92px;color:#fff;text-align:center;cursor:pointer;user-select:none}
    .desktop-icon img{display:block;margin:0 auto 4px auto}
    .window{width:100%;max-width:540px;background:var(--win);border:2px solid;box-shadow:2px 2px 6px rgba(0,0,0,.5);position:relative;z-index:100}
    .title-bar{background:#222;color:#fff;padding:6px 10px;display:flex;justify-content:space-between;align-items:center;cursor:move}
    .title-bar .controls button{margin-left:6px;border:1px solid;cursor:pointer;background:var(--win);padding:2px 8px}
    .content{padding:12px;font-size:14px;color:#000}
    .win95-inset{border:2px inset #808080;background:var(--win);padding:6px}
    .win95-list{background:#fff;border:2px inset #808080;padding:6px;height:92px;overflow:auto}
    .list-item{padding:6px;font-size:13px;cursor:pointer;user-select:none}
    .list-item.selected{background:var(--accent);color:#fff}
    .drop-zone{border:2px dashed #808080;padding:18px;text-align:center;margin-top:10px;background:rgba(255,255,255,.28);cursor:pointer;position:relative}
    .drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .button-group{display:flex;gap:8px;margin-top:10px}
    .button-group button{flex:1;padding:10px;font-size:15px;cursor:pointer;background:var(--win);border:2px outset var(--win)}
    #file-info{background:#fff;border:2px inset #808080;padding:10px;margin-top:10px;max-height:180px;overflow:auto;font-size:13px}
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center}
    #loader{background:var(--win);padding:14px;border:2px solid;box-shadow:0 4px 16px rgba(0,0,0,.4);width:360px}
    .progress{display:flex;gap:2px;margin-top:8px}
    .seg{flex:1;height:18px;background:#c0c0c0;border:1px solid #b0b0b0}
    .seg.active{background:var(--accent)}
    .taskbar{position:fixed;left:0;right:0;bottom:0;height:36px;background:var(--win);display:flex;align-items:center;padding:0 12px;border-top:2px solid #fff;z-index:90}
    .status{margin-left:auto}
    .wave-view{margin-top:12px;border:2px inset #808080;background:#e8e8e8;padding:8px;display:flex;flex-direction:column;gap:8px}
    .wave-canvas{height:96px;background:#000;overflow:hidden}
    .play-btn{padding:8px;background:var(--win);border:2px outset var(--win);cursor:pointer}
    .info{font-size:13px;margin-top:8px}
    .warning{display:none;padding:8px;margin-top:8px;border-radius:3px}
    .memory-warning{background:#fff3e0;border:1px solid #ff9800;color:#ff6f00}
    .mobile-warning{background:#e3f2fd;border:1px solid #2196f3;color:#1976d2}
    @media (max-width:520px){.window{max-width:100%}}
  </style>
</head>
<body>
  <div class="desktop-icon" title="Open">
    <img width="56" height="56" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgdmlld0JveD0iMCAwIDU2IDU2Ij4KPHBhdGggZD0iTTM2IDQ4aC04djRIMjR2LTNoOC42YTEuNiAxLjYgMCAwIDAgMS4yLS41bDEuNy0yLjZsMS42LTJjLjItLjIuMy0uNS4zLS44LjAtLjMuMDItLjUuMDItLjhsLTEuNC0yLjljLS4zLS43LS45LTEuMy0xLjYtMS43LS41LS4yLTEuMS0uMy0xLjctLjNsLS45LS4yYTEuOCAxLjggMCAwIDAtMS42LjcgNS40IDUuNCAwIDAgMS0zLjkgMS41SDM2eiIgZmlsbD0iI2U1MzkzNSIvPgo8L3N2Zz4=" />
    <div style="font-size:13px">KO II Tool</div>
  </div>

  <div class="window" id="app-window">
    <div class="title-bar" id="title-bar">
      <div>SpeedUpperCut</div>
      <div class="controls">
        <button id="min-btn" title="Minimize">_</button>
        <button id="close-btn" title="Close">×</button>
      </div>
    </div>

    <div class="content">
      <div class="warning memory-warning" id="memory-warning"><i class="fas fa-exclamation-triangle"></i> Processing large files may use significant memory.</div>
      <div class="warning mobile-warning" id="mobile-warning"><i class="fas fa-mobile-alt"></i> Mobile processing may be slow.</div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="win95-inset" style="flex:1">
          <label>FIDELITY</label>
          <div class="win95-list" data-group="fidelity">
            <div class="list-item selected" data-value="cd">CD (44.1 kHz, 16-bit)</div>
            <div class="list-item" data-value="sp8">SP-1200 (22kHz, 8-bit)</div>
            <div class="list-item" data-value="sp16">SP-1200 (22kHz, 16-bit)</div>
            <div class="list-item" data-value="sk">SK-1 (9kHz, 8-bit)</div>
          </div>
        </div>
        <div class="win95-inset" style="flex:1">
          <label>CHANNELS</label>
          <div class="win95-list" data-group="channels">
            <div class="list-item selected" data-value="stereo">Stereo</div>
            <div class="list-item" data-value="mono">Mono</div>
          </div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <input id="auto-trim" type="checkbox" checked />
        <label for="auto-trim">Auto-trim silence at start/end</label>
      </div>

      <div class="drop-zone" id="drop-zone">
        <i class="fas fa-cloud-upload-alt" style="font-size:32px"></i>
        <input id="file-input" type="file" accept="audio/*" multiple />
        <span style="display:block;margin-top:8px">Перетащи файлы или щелкни для выбора (файлы/папки)</span>
        <div class="info" style="margin-top:6px">Supported: WAV, MP3, AAC, OGG, FLAC</div>
      </div>

      <div class="button-group">
        <button id="select-btn">Select Files</button>
        <button id="select-folder-btn">Select Folder</button>
        <button id="clear-btn">Clear</button>
      </div>

      <div id="file-info">Drop or select audio files/folders to process</div>

      <div class="wave-view" id="wave-view">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong id="wave-title">Processed preview</strong>
          <div>
            <button id="download-processed" class="play-btn" disabled title="Download processed">Download WAV</button>
          </div>
        </div>
        <div class="wave-canvas" id="wave-canvas"></div>
        <button id="play-toggle" class="play-btn" disabled><i class="fas fa-play"></i> Play</button>
      </div>
    </div>
  </div>

  <div id="overlay"><div id="loader">
    <div id="loader-title">Processing…</div>
    <div class="progress" id="progress"><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div></div>
    <div id="current-file" style="margin-top:8px;font-size:13px">Preparing</div>
    <div style="margin-top:10px"><button id="cancel-btn">Cancel</button></div>
  </div></div>

  <div class="taskbar"><div class="start-btn"><i class="fas fa-bars"></i> Start</div><div class="status" id="status">Ready</div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <script>
    let audioCtx = null;
    let createdURLs = [];
    let processingCancelled = false;
    let currentJob = null;
    const MAX_CONCURRENT = Math.max(2, Math.min(6, Math.floor((navigator.hardwareConcurrency||4)/2)));
    const BATCH = 5;
    const waveformQueue = [];
    let wfBusy = false;
    let wavesurfer = null;
    let lastProcessedBlob = null;

    document.addEventListener('DOMContentLoaded', () => {
      setupUI();
      restoreSettings();
      if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) document.getElementById('mobile-warning').style.display='block';
      if (navigator.deviceMemory && navigator.deviceMemory < 4) document.getElementById('memory-warning').style.display='block';
    });

    function setupUI() {
      const lists = document.querySelectorAll('.win95-list');
      lists.forEach(group => group.addEventListener('click', e => {
        if (e.target.classList.contains('list-item')) {
          group.querySelectorAll('.list-item').forEach(i=>i.classList.remove('selected'));
          e.target.classList.add('selected');
          saveSettings();
          setStatus(`Set: ${e.target.textContent}`);
        }
      }));

      const drop = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      const selectBtn = document.getElementById('select-btn');
      const selectFolderBtn = document.getElementById('select-folder-btn');
      const clearBtn = document.getElementById('clear-btn');
      const cancelBtn = document.getElementById('cancel-btn');

      drop.addEventListener('dragover', e=>{e.preventDefault();drop.classList.add('dragover')});
      drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
      drop.addEventListener('drop', handleDrop);

      selectBtn.addEventListener('click', ()=>fileInput.click());
      selectFolderBtn.addEventListener('click', ()=>selectFolder());
      clearBtn.addEventListener('click', ()=>document.getElementById('file-info').innerHTML = 'Drop or select audio files/folders to process');
      cancelBtn.addEventListener('click', ()=>{processingCancelled=true; if (currentJob && currentJob.cancel) currentJob.cancel(); hideOverlay(); setStatus('Cancelled')});

      fileInput.addEventListener('change', e => {handleFiles(Array.from(e.target.files)); e.target.value='';});

      document.getElementById('play-toggle').addEventListener('click', togglePlay);
      document.getElementById('download-processed').addEventListener('click', ()=>{ if (lastProcessedBlob) downloadBlob(lastProcessedBlob, 'processed.wav') });

      document.getElementById('min-btn').addEventListener('click', ()=>document.getElementById('app-window').style.display='none');
      document.getElementById('close-btn').addEventListener('click', ()=>document.getElementById('app-window').style.display='none');

      makeDraggable(document.getElementById('title-bar'));
    }

    function setStatus(t){document.getElementById('status').textContent = t}
    function showOverlay(){document.getElementById('overlay').style.display='flex'}
    function hideOverlay(){document.getElementById('overlay').style.display='none'}

    function selectFolder(){
      const el = document.createElement('input');
      el.type = 'file';
      el.webkitdirectory = true;
      el.multiple = true;
      el.addEventListener('change', e => handleFiles(Array.from(e.target.files)));
      el.click();
    }

    function handleDrop(e){
      e.preventDefault();
      e.dataTransfer && e.dataTransfer.files && handleFiles(Array.from(e.dataTransfer.files));
      e.dataTransfer && e.dataTransfer.items && e.dataTransfer.items.clear && e.dataTransfer.items.clear();
      document.getElementById('drop-zone').classList.remove('dragover');
    }

    async function handleFiles(files){
      if (!files || files.length===0) { setStatus('No files'); return; }
      showOverlay(); setStatus(`Processing ${files.length} files`); processingCancelled=false;
      document.getElementById('file-info').innerHTML = '<div>Processing started...</div>';
      const zip = new JSZip();
      let processedCount=0, totalOrig=0, totalProc=0, totalTrimmed=0, stereo=0, mono=0;
      const segments = document.querySelectorAll('.seg');
      segments.forEach(s=>s.classList.remove('active'));

      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      currentJob = { cancel: ()=>{processingCancelled=true; try{audioCtx.close()}catch(e){} } };

      for (let i=0;i<files.length;i+=BATCH){
        if (processingCancelled) break;
        const batch = files.slice(i,i+BATCH);
        await Promise.all(batch.map((f,idx)=>processSingleFile({file:f,path:f.webkitRelativePath||f.name}, i+idx, files.length, zip).then(r=>{
          if (!r) return;
          processedCount++; totalOrig += r.originalSize||0; totalProc += r.processedSize||0; totalTrimmed += r.trimmedSamples||0;
          if (r.channels===1) mono++; else stereo++;
          enqueueWave(r.buffer, r.fileName);
          const segIdx = Math.floor(processedCount / files.length * segments.length);
          for (let s=0;s<segments.length;s++) segments[s].classList.toggle('active', s<=segIdx);
        }).catch(err=>{appendFileInfo('Error: '+(err.message||err));})));
      }

      if (!processingCancelled && processedCount>0){
        const zipBlob = await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
        const url = URL.createObjectURL(zipBlob); createdURLs.push(url); safeRevoke(url,8000);
        const a = document.createElement('a'); a.href=url; a.download='ko2_processed_audio.zip'; document.body.appendChild(a); a.click(); a.remove();
        appendFileInfo(`<div><b>Processed ${processedCount} files</b></div><div>Original: ${formatBytes(totalOrig)}, Processed: ${formatBytes(totalProc)}</div><div>Saved: ${totalOrig>0 ? (100-(totalProc/totalOrig*100)).toFixed(1)+'%' : '0%'}</div>`);
      }
      hideOverlay(); setStatus('Done');
      currentJob = null;
    }

    async function processSingleFile(item, index, total, zip){
      const file = item.file;
      const infoEl = document.getElementById('file-info');
      try {
        appendFileInfo(`Processing: ${escapeHTML(item.path)}`);
        if (!isSupported(file.name,file.type)) throw new Error('Unsupported format');
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ab = await file.arrayBuffer();
        const decoded = await decodeAudio(ab);
        if (!decoded) throw new Error('Decode failed');
        const channels = decoded.numberOfChannels||1;
        const fidelity = getSelected('fidelity');
        const chSetting = getSelected('channels');
        let processed = await transformAudio(decoded, fidelity, chSetting);
        if (document.getElementById('auto-trim').checked){
          const before = processed.length;
          processed = trimSilence(processed);
          const after = processed.length;
          const trimmed = Math.max(0, before-after);
          appendFileInfo(`Trimmed ${(trimmed/processed.sampleRate).toFixed(2)}s`);
        }
        const pathParts = item.path.split('/'); const orig = pathParts.pop();
        const newName = orig.replace(/\.[^.]+$/,'') + '_ko2.wav';
        const outPath = [...pathParts,newName].join('/');
        const blob = await audioBufferToWavBlob(processed);
        zip.file(outPath, blob);
        appendFileInfo(`<div>Saved: ${escapeHTML(outPath)} — ${formatBytes(blob.size)}</div>`);
        await updateProgress((index+1)/total);
        lastProcessedBlob = blob;
        return { buffer: processed, fileName: outPath, originalSize: file.size||0, processedSize: blob.size||0, trimmedSamples:0, channels };
      } catch (err) {
        appendFileInfo(`<div style="color:#c62828">Error ${escapeHTML(item.path)}: ${escapeHTML(err.message||String(err))}</div>`);
        console.error(err);
        return null;
      }
    }

    function getSelected(group){ const el=document.querySelector(`.win95-list[data-group="${group}"] .list-item.selected`); return el?.dataset?.value||'' }
    function isSupported(name,type){ const ext = name.split('.').pop().toLowerCase(); return ['wav','mp3','ogg','aac','flac','m4a'].includes(ext) || /audio\//.test(type) }

    async function decodeAudio(arrayBuffer){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      try {
        return await audioCtx.decodeAudioData(arrayBuffer);
      } catch (e){
        return await new Promise((res,rej)=>{ audioCtx.decodeAudioData(arrayBuffer, res, rej) });
      }
    }

    function getFidelity(f){ switch(f){case'sp8':return{sampleRate:22050,bitDepth:8};case'sp16':return{sampleRate:22050,bitDepth:16};case'sk':return{sampleRate:9000,bitDepth:8};default:return{sampleRate:44100,bitDepth:16}}}

    async function transformAudio(buffer,fidelity,channels){
      const f=getFidelity(fidelity);
      const targetChannels = channels==='mono'?1:2;
      const speed = 2.0;
      const converted = await convertChannels(buffer, targetChannels);
      return await changeSpeedAndSampleRate(converted, speed, f.sampleRate);
    }

    async function convertChannels(buffer,targetChannels){
      if (buffer.numberOfChannels===targetChannels) return buffer;
      const ctx = new OfflineAudioContext(targetChannels, buffer.length, buffer.sampleRate);
      const src = ctx.createBufferSource(); src.buffer = buffer;
      src.connect(ctx.destination);
      src.start();
      return await ctx.startRendering();
    }

    async function changeSpeedAndSampleRate(buffer,speed,sampleRate){
      const duration = buffer.duration / speed;
      const length = Math.ceil(duration * sampleRate);
      const ctx = new OfflineAudioContext(buffer.numberOfChannels, length, sampleRate);
      const src = ctx.createBufferSource(); src.buffer = buffer; src.playbackRate.value = speed;
      src.connect(ctx.destination); src.start();
      return await ctx.startRendering();
    }

    function audioBufferToWavBlob(buffer){
      return new Promise(res=>setTimeout(()=>{ try{ res(bufferToWav(buffer)) }catch(e){res(new Blob())} },0));
    }

    function bufferToWav(buffer){
      const fidelity = getFidelity(getSelected('fidelity'));
      const bitDepth = fidelity.bitDepth;
      const numChannels = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const bytesPerSample = bitDepth===8?1:2;
      const blockAlign = numChannels * bytesPerSample;
      const dataLength = buffer.length * blockAlign;
      const riffLen = 4 + (8+16) + (8+4) + (8 + dataLength);
      const buf = new ArrayBuffer(12 + (8+16) + (8+4) + (8+dataLength));
      const view = new DataView(buf);
      writeStr(view,0,'RIFF'); view.setUint32(4, riffLen, true); writeStr(view,8,'WAVE');
      let offset=12;
      writeStr(view,offset,'fmt '); view.setUint32(offset+4,16,true); view.setUint16(offset+8,1,true); view.setUint16(offset+10,numChannels,true); view.setUint32(offset+12,sampleRate,true); view.setUint32(offset+16,sampleRate*blockAlign,true); view.setUint16(offset+20,blockAlign,true); view.setUint16(offset+22,bitDepth,true); offset+=8+16;
      writeStr(view,offset,'ko2 '); view.setUint32(offset+4,4,true); view.setInt8(offset+8,-12); view.setUint16(offset+9,255,true); view.setUint8(offset+11,1); offset += 8+4;
      writeStr(view,offset,'data'); view.setUint32(offset+4,dataLength,true); offset+=8;
      if (bitDepth===8){
        const dv = new Uint8Array(buf,offset,dataLength); let p=0;
        for (let i=0;i<buffer.length;i++) for (let ch=0;ch<numChannels;ch++){ const s=buffer.getChannelData(ch)[i]; dv[p++]=Math.max(0,Math.min(255,Math.round((s+1)*127.5))); }
      } else {
        const dv = new DataView(buf,offset); let p=0;
        for (let i=0;i<buffer.length;i++) for (let ch=0;ch<numChannels;ch++){ const s=Math.max(-1,Math.min(1,buffer.getChannelData(ch)[i])); const v = s<0?Math.round(s*32768):Math.round(s*32767); dv.setInt16(p,v,true); p+=2; }
      }
      return new Blob([buf],{type:'audio/wav'});
    }

    function writeStr(view,offset,str){ for (let i=0;i<str.length;i++) view.setUint8(offset+i,str.charCodeAt(i)) }

    function trimSilence(audioBuffer,thresholdDb=-40){
      const thr = Math.pow(10,thresholdDb/20);
      const sr = audioBuffer.sampleRate;
      const ch0 = audioBuffer.getChannelData(0);
      let start=0,end=ch0.length-1,block=1024;
      for (let i=0;i<ch0.length;i+=block){ let found=false; const jend=Math.min(i+block,ch0.length); for (let j=i;j<jend;j++) if (Math.abs(ch0[j])>thr){ start=Math.max(0,j-block); found=true; break;} if(found) break }
      for (let i=ch0.length-1;i>0;i-=block){ let found=false; const jstart=Math.max(0,i-block); for (let j=i;j>=jstart;j--) if (Math.abs(ch0[j])>thr){ end=Math.min(ch0.length-1,j+block); found=true; break;} if(found) break }
      start=Math.max(0,start-Math.floor(0.05*sr)); end=Math.min(ch0.length-1,end+Math.floor(0.05*sr));
      if (start>=end) return audioBuffer;
      const newLen = end-start+1;
      const out = new AudioBuffer({length:newLen,numberOfChannels:audioBuffer.numberOfChannels,sampleRate:audioBuffer.sampleRate});
      for (let ch=0;ch<audioBuffer.numberOfChannels;ch++){ out.getChannelData(ch).set(audioBuffer.getChannelData(ch).subarray(start,end+1)) }
      return out;
    }

    function appendFileInfo(html){ const el=document.getElementById('file-info'); const d=document.createElement('div'); d.innerHTML=html; el.appendChild(d); el.scrollTop=el.scrollHeight }

    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' })[c]) }
    function formatBytes(b){ if(!b) return '0 B'; if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB' }

    function updateProgress(p){
      return new Promise(res=>{ const segs=document.querySelectorAll('.seg'); const to = Math.floor(p*segs.length); segs.forEach((s,i)=>s.classList.toggle('active', i<to)); setTimeout(res,20) })
    }

    function enqueueWave(buffer,fileName){
      waveformQueue.push({buffer,fileName});
      if (!wfBusy) processWaveQueue();
    }

    async function processWaveQueue(){
      if (waveformQueue.length===0) { wfBusy=false; return }
      wfBusy=true;
      const job = waveformQueue.shift();
      try{ await renderWave(job.buffer, job.fileName) }catch(e){console.error(e)}
      setTimeout(processWaveQueue,0);
    }

    async function renderWave(buffer, filename){
      const container = document.getElementById('wave-canvas');
      const title = document.getElementById('wave-title');
      title.textContent = filename;
      if (!window.WaveSurfer) throw new Error('WaveSurfer missing');
      if (!wavesurfer){ wavesurfer = WaveSurfer.create({container:container,height:96,normalize:true,fillParent:true}); wavesurfer.on('ready', ()=>{ document.getElementById('play-toggle').disabled=false; document.getElementById('download-processed').disabled=false }); wavesurfer.on('error',e=>console.error(e)); }
      const wavBlob = bufferToWav(buffer);
      lastProcessedBlob = wavBlob;
      const url = URL.createObjectURL(wavBlob); createdURLs.push(url); safeRevoke(url,60000);
      if (wavesurfer.isReady) try{ wavesurfer.empty() }catch(e){}
      try{
        const audio = document.createElement('audio'); audio.src=url; audio.preload='auto'; audio.crossOrigin='anonymous';
        audio.addEventListener('canplay', ()=>{ if (typeof wavesurfer.loadMediaElement==='function') wavesurfer.loadMediaElement(audio); else wavesurfer.load(url) });
        setTimeout(()=>{ try{ if (!wavesurfer.isReady) wavesurfer.load(url) }catch(e){} },800);
      }catch(e){ console.error(e) }
    }

    function togglePlay(){
      if (!wavesurfer) return;
      const btn = document.getElementById('play-toggle');
      if (wavesurfer.isPlaying()){ wavesurfer.pause(); btn.innerHTML = '<i class="fas fa-play"></i> Play'; setStatus('Paused') }
      else { wavesurfer.play(); btn.innerHTML = '<i class="fas fa-pause"></i> Pause'; setStatus('Playing') }
    }

    function downloadBlob(blob,name){ const u=URL.createObjectURL(blob); createdURLs.push(u); safeRevoke(u,8000); const a=document.createElement('a'); a.href=u; a.download=name; document.body.appendChild(a); a.click(); a.remove() }

    function safeRevoke(url,delay=60000){ setTimeout(()=>{ try{ URL.revokeObjectURL(url) }catch(e){} createdURLs = createdURLs.filter(u=>u!==url) }, delay) }

    function makeDraggable(el){
      let x=0,y=0,px=0,py=0;
      el.addEventListener('mousedown',e=>{ e.preventDefault(); px=e.clientX; py=e.clientY; document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up) });
      function mm(e){ const win=document.getElementById('app-window'); win.style.position='absolute'; win.style.left=(win.offsetLeft+(e.clientX-px))+'px'; win.style.top=(win.offsetTop+(e.clientY-py))+'px'; px=e.clientX; py=e.clientY }
      function up(){ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up) }
    }

    function appendFileInfoText(t){ appendFileInfo(escapeHTML(t)) }

    function saveSettings(){ try{ localStorage.setItem('ko2', JSON.stringify({ fidelity:getSelected('fidelity'), channels:getSelected('channels'), autoTrim:document.getElementById('auto-trim').checked })) }catch(e){} }
    function restoreSettings(){ try{ const r = JSON.parse(localStorage.getItem('ko2')||'{}'); if (r.fidelity) document.querySelectorAll('.win95-list[data-group="fidelity"] .list-item').forEach(i=>i.classList.toggle('selected', i.dataset.value===r.fidelity)); if (r.channels) document.querySelectorAll('.win95-list[data-group="channels"] .list-item').forEach(i=>i.classList.toggle('selected', i.dataset.value===r.channels)); if (typeof r.autoTrim==='boolean') document.getElementById('auto-trim').checked=r.autoTrim }catch(e){} }

    window.addEventListener('beforeunload', ()=>{ createdURLs.forEach(u=>{ try{ URL.revokeObjectURL(u) }catch(e){} }) });

  </script>
</body>
</html>