<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KO II SpeedUpperCut v0.0.32</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="24" y="40" width="16" height="16" fill="#e53935" stroke="black" stroke-width="2"/><rect x="26" y="44" width="12" height="4" fill="#b71c1c"/><polygon points="32,32 28,28 30,24 34,26 36,22 38,30" fill="orange" stroke="black" stroke-width="1"/></svg>'>
  <style>
    /* ... (предыдущие стили остаются без изменений) ... */
    
    /* Новые стили для перетаскивания окна */
    .window {
      position: absolute;
      top: 100px;
      left: calc(50% - 240px);
    }
    
    .wave-selector {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
      background: #fff;
      border: 2px inset #808080;
    }
  </style>
</head>
<body>
  <!-- Иконка на рабочем столе -->
  <div class="desktop-icon" style="top: 20px; left: 30px;" onclick="openMainWindow()">
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij4KICA8cmVjdCB4PSIyNCIgeT0iNDAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iI2U1MzkzNSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPHJlY3QgeD0iMjYiIHk9IjQ0IiB3aWR0aD0iMTIiIGhlaWdodD0iNCIgZmlsbD0iI2I3MWMxYyIvPgogIDxwb2x5Z29uIHBvaW50cz0iMzIsMzIgMjgsMjggMzAsMjQgMzQsMjYgMzYsMjIgMzgsMzAiIGZpbGw9Im9yYW5nZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg==" 
         width="48" height="48">
    <div>KO II Tool</div>
  </div>
  
  <!-- Главное окно -->
  <div class="window" id="main-window">
    <div class="title-bar" id="main-title-bar">
      <span>KO II SpeedUpperCut v0.0.32</span>
      <div class="window-controls">
        <button class="minimize" title="Minimize">_</button>
        <button class="close" title="Close">×</button>
      </div>
    </div>
    <div class="content">
      <!-- ... (остальное содержимое без изменений) ... -->
    </div>
  </div>

  <!-- Окно волн (одно на все файлы) -->
  <div class="window" id="wave-window" style="display: none; top: 150px; left: 100px;">
    <div class="title-bar" id="wave-title-bar">
      <span>Processed Samples</span>
      <div class="window-controls">
        <button class="minimize" title="Minimize">_</button>
        <button class="close" title="Close">×</button>
      </div>
    </div>
    <div class="content">
      <select class="wave-selector" id="wave-selector">
        <option value="">Select a sample...</option>
      </select>
      
      <div class="wave-container">
        <div class="wave-element" id="wave-container"></div>
        <button class="wave-button" id="play-button">
          <i class="fas fa-play"></i> Play Sample
        </button>
      </div>
    </div>
  </div>

  <!-- ... (остальные элементы без изменений) ... -->

  <script>
    // Глобальные переменные
    let wavesurfer = null;
    let processedSamples = {};
    let currentPlayingSample = null;
    
    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
      initWindowDrag();
    });
    
    function openMainWindow() {
      document.getElementById('main-window').style.display = 'block';
    }

    // Инициализация перетаскивания окон
    function initWindowDrag() {
      const windows = [
        { id: 'main-window', titleBar: 'main-title-bar' },
        { id: 'wave-window', titleBar: 'wave-title-bar' }
      ];
      
      windows.forEach(win => {
        const windowElement = document.getElementById(win.id);
        const titleBar = document.getElementById(win.titleBar);
        
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        titleBar.addEventListener('mousedown', dragMouseDown);
        
        function dragMouseDown(e) {
          e.preventDefault();
          // Поднимаем окно на верхний план
          windowElement.style.zIndex = ++windowZIndex;
          
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.addEventListener('mouseup', closeDragElement);
          document.addEventListener('mousemove', elementDrag);
        }
        
        function elementDrag(e) {
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          windowElement.style.top = (windowElement.offsetTop - pos2) + "px";
          windowElement.style.left = (windowElement.offsetLeft - pos1) + "px";
        }
        
        function closeDragElement() {
          document.removeEventListener('mouseup', closeDragElement);
          document.removeEventListener('mousemove', elementDrag);
        }
      });
    }

    // Фиксированные метаданные для KO II
    function getKOIISettings() {
      return {
        pitch: 0,      // Фиксированное минимальное значение
        release: 255,  // Фиксированное максимальное значение
        playmode: 0    // Фиксированный режим One-shot
      };
    }

    // Обработка элементов (добавлено сохранение для визуализации)
    async function processItems(items) {
      // ... (предыдущий код обработки) ...
      
      for (let i = 0; i < items.length; i++) {
        // ... (обработка файла) ...
        
        // Сохраняем для визуализации
        processedSamples[fileName] = {
          buffer: processed,
          blob: wavBlob
        };
        
        // Добавляем в выпадающий список
        const option = document.createElement('option');
        option.value = fileName;
        option.textContent = fileName;
        document.getElementById('wave-selector').appendChild(option);
      }
      
      // ... (после обработки) ...
    }

    // Инициализация Wavesurfer
    async function initWavesurfer() {
      await loadWavesurfer();
      
      if (typeof WaveSurfer === 'undefined') {
        throw new Error('Wavesurfer failed to load');
      }
      
      wavesurfer = WaveSurfer.create({
        container: '#wave-container',
        waveColor: '#0f0',
        progressColor: '#ff0',
        height: 100,
        barWidth: 2,
        cursorColor: '#f00'
      });
      
      // Обработчик для кнопки воспроизведения
      document.getElementById('play-button').addEventListener('click', () => {
        if (wavesurfer.isPlaying()) {
          wavesurfer.pause();
          document.getElementById('play-button').innerHTML = '<i class="fas fa-play"></i> Play Sample';
          updateStatus("Playback paused");
        } else {
          const fileName = document.getElementById('wave-selector').value;
          if (fileName) {
            playSample(fileName);
          }
        }
      });
      
      // Обработчик переключения сэмплов
      document.getElementById('wave-selector').addEventListener('change', function() {
        if (wavesurfer.isPlaying()) {
          wavesurfer.stop();
          document.getElementById('play-button').innerHTML = '<i class="fas fa-play"></i> Play Sample';
          updateStatus("Playback stopped");
        }
        
        const fileName = this.value;
        if (fileName && processedSamples[fileName]) {
          loadSample(fileName);
        }
      });
    }

    // Загрузка сэмпла в Wavesurfer
    function loadSample(fileName) {
      if (!wavesurfer) return;
      
      const sample = processedSamples[fileName];
      if (!sample) return;
      
      wavesurfer.loadBlob(sample.blob);
      updateStatus(`Loaded: ${fileName}`);
    }

    // Воспроизведение сэмпла
    function playSample(fileName) {
      if (!wavesurfer) return;
      
      // Если пытаемся играть другой сэмпл - сначала загружаем
      if (currentPlayingSample !== fileName) {
        loadSample(fileName);
      }
      
      wavesurfer.play();
      document.getElementById('play-button').innerHTML = '<i class="fas fa-pause"></i> Pause';
      updateStatus(`Playing: ${fileName}`);
      currentPlayingSample = fileName;
    }

    // Генерация WAV с фиксированными метаданными
    function audioBufferToWav(buffer) {
      const ko2Settings = getKOIISettings();
      const ko2Chunk = writeKO2Chunk(
        ko2Settings.pitch,
        ko2Settings.release,
        ko2Settings.playmode
      );
      
      // ... (остальной код без изменений) ...
    }
    
    // Функция создания чанка метаданных (совместимая с KO II)
    function writeKO2Chunk(pitch, release, playmode) {
      const buffer = new ArrayBuffer(12);
      const view = new DataView(buffer);
      
      // Идентификатор чанка "ko2 "
      view.setUint32(0, 0x6B6F3220); // 'ko2 ' в hex
      
      // Размер данных (4 байта)
      view.setUint32(4, 4, true);
      
      // Параметры
      view.setInt8(8, pitch);     // Pitch (-24 to +24)
      view.setUint16(9, release); // Release (0-255)
      view.setUint8(11, playmode);// Playmode (0,1,2)
      
      return buffer;
    }

    // ... (остальной код без изменений) ...
  </script>
</body>
</html>